# Nextcloud Docker Compose Configuration
# Deploy to: /opt/nextcloud/docker-compose.yml
#
# Usage:
#   cd /opt/nextcloud
#   docker compose up -d
#
# Logs:
#   docker compose logs -f app
#
# Whiteboard Setup (after first deployment):
#   1. Install the Whiteboard app from Nextcloud App Store or run:
#      docker exec -u www-data nextcloud-app php occ app:install whiteboard
#   2. Configure the whiteboard server URL:
#      docker exec -u www-data nextcloud-app php occ config:app:set whiteboard collabBackendUrl --value="https://collabcloud.bollman-roets.de/whiteboard"
#   3. Set the JWT secret (must match WHITEBOARD_SECRET in .env):
#      docker exec -u www-data nextcloud-app php occ config:app:set whiteboard jwt_secret_key --value="<your-secret>"

services:
  db:
    image: mariadb:10.11
    container_name: nextcloud-db
    restart: unless-stopped
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    volumes:
      - ./db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
    networks:
      - nextcloud
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 3

  redis:
    image: redis:7-alpine
    container_name: nextcloud-redis
    restart: unless-stopped
    volumes:
      - ./redis:/data
    networks:
      - nextcloud
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  app:
    image: nextcloud:29-apache
    container_name: nextcloud-app
    restart: unless-stopped
    ports:
      - "127.0.0.1:8080:80"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./data:/var/www/html
      - ./config:/var/www/html/config
    environment:
      - MYSQL_HOST=db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - NEXTCLOUD_ADMIN_USER=${ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=collabcloud.bollmann-roets.de collabcloud.bollman-roets.de
      - OVERWRITEPROTOCOL=https
      - OVERWRITEHOST=collabcloud.bollmann-roets.de
      - PHP_MEMORY_LIMIT=512M
      - PHP_UPLOAD_LIMIT=10G
    networks:
      - nextcloud

  # Whiteboard server for real-time collaboration (Excalidraw-based)
  whiteboard:
    image: ghcr.io/nextcloud-releases/whiteboard:stable
    container_name: nextcloud-whiteboard
    restart: unless-stopped
    ports:
      - "127.0.0.1:3002:3002"
    environment:
      - NEXTCLOUD_URL=https://collabcloud.bollmann-roets.de
      - JWT_SECRET_KEY=${WHITEBOARD_SECRET}
    networks:
      - nextcloud

networks:
  nextcloud:
    driver: bridge
